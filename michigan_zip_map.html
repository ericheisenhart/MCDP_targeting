<!DOCTYPE html>
<html>
<head>
    <title>Michigan ZIP Code Campaigns</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .legend { 
            background: white; 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
        }
        .legend h4 { margin: 0 0 10px 0; }
        .legend-item { margin: 3px 0; font-size: 12px; }
        .legend-color { 
            width: 15px; 
            height: 15px; 
            display: inline-block; 
            margin-right: 5px; 
            border: 1px solid #999;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading campaign data...</div>
    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([44.3, -84.5], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Function to load and process CSV data
        async function loadCampaignData() {
            try {
                const response = await fetch('MCDP_Location_Targeting.csv');
                if (!response.ok) {
                    throw new Error(`Failed to load CSV: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                console.warn('CSV parsing warnings:', results.errors);
                            }
                            resolve(results.data);
                        },
                        error: function(error) {
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading campaign data:', error);
                throw error;
            }
        }

        // Function to process campaign data and create map
        async function initializeMap() {
            try {
                // Load campaign data from CSV
                const campaignData = await loadCampaignData();
                console.log('Loaded campaign data:', campaignData.length, 'rows');

                // Parse location data - handle both ZIP codes and radius targets
                const zipToCampaign = {};
                const radiusTargets = [];
                
                campaignData.forEach(row => {
                    if (row.Location && row.Location.includes('|mi|')) {
                        // Parse radius format: "10.0|mi|1305 S Main St, Chelsea, MI 48118"
                        const parts = row.Location.split('|mi|');
                        const radius = parseFloat(parts[0]);
                        const address = parts[1];
                        radiusTargets.push({
                            address: address,
                            radius: radius,
                            campaign: row.Campaign
                        });
                    } else if (row.Location) {
                        // Regular ZIP code
                        const zip = row.Location.split(',')[0];
                        zipToCampaign[zip] = row.Campaign;
                    }
                });

                // Generate colors for campaigns
                const campaigns = [...new Set(campaignData.map(row => row.Campaign).filter(Boolean))];
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'];
                const campaignColors = {};
                campaigns.forEach((campaign, i) => {
                    campaignColors[campaign] = colors[i % colors.length];
                });

                // Sample Michigan ZIP GeoJSON (replace with your 20MB file)
                const sampleZipData = {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "properties": {"ZCTA5CE10": "48083"},
                            "geometry": {
                                "type": "Polygon",
                                "coordinates": [[[-83.2, 42.5], [-83.1, 42.5], [-83.1, 42.6], [-83.2, 42.6], [-83.2, 42.5]]]
                            }
                        }
                        // This is just a sample - your real GeoJSON will have hundreds of ZIP polygons
                    ]
                };

                // Style function for ZIP codes
                function getStyle(feature) {
                    const zip = feature.properties.ZCTA5CE10;
                    const campaign = zipToCampaign[zip];
                    return {
                        fillColor: campaign ? campaignColors[campaign] : '#cccccc',
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                }

                // Add ZIP polygons to map
                function onEachFeature(feature, layer) {
                    const zip = feature.properties.ZCTA5CE10;
                    const campaign = zipToCampaign[zip];
                    if (campaign) {
                        layer.bindPopup(`<b>ZIP: ${zip}</b><br>${campaign}`);
                    }
                }

                // Load GeoJSON and add radius circles
                try {
                    const geoResponse = await fetch('mi_michigan_zip_codes_geo.min.json');
                    if (geoResponse.ok) {
                        const data = await geoResponse.json();
                        console.log('GeoJSON loaded, features:', data.features?.length);
                        
                        // Add ZIP polygons
                        L.geoJSON(data, {
                            style: getStyle,
                            onEachFeature: onEachFeature
                        }).addTo(map);
                    } else {
                        console.warn('GeoJSON file not found, using sample data');
                        // Use sample data if GeoJSON file doesn't exist
                        L.geoJSON(sampleZipData, {
                            style: getStyle,
                            onEachFeature: onEachFeature
                        }).addTo(map);
                    }
                } catch (geoError) {
                    console.warn('Failed to load GeoJSON:', geoError);
                    // Use sample data as fallback
                    L.geoJSON(sampleZipData, {
                        style: getStyle,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                }
                
                // Add radius circles (requires geocoding addresses)
                radiusTargets.forEach(target => {
                    // Simple geocoding using Nominatim (free)
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(target.address)}`;
                    
                    fetch(geocodeUrl)
                        .then(r => r.json())
                        .then(results => {
                            if (results.length > 0) {
                                const lat = parseFloat(results[0].lat);
                                const lon = parseFloat(results[0].lon);
                                
                                // Add circle
                                const circle = L.circle([lat, lon], {
                                    color: campaignColors[target.campaign],
                                    fillColor: campaignColors[target.campaign],
                                    fillOpacity: 0.3,
                                    radius: target.radius * 1609.34 // Convert miles to meters
                                }).addTo(map);
                                
                                // Add popup
                                circle.bindPopup(`<b>${target.campaign}</b><br>${target.radius} mile radius<br>${target.address}`);
                            }
                        })
                        .catch(err => console.warn('Geocoding failed for:', target.address));
                });

                // Create legend
                const legend = L.control({position: 'topright'});
                legend.onAdd = function() {
                    const div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = '<h4>Campaigns</h4>';
                    campaigns.forEach(campaign => {
                        div.innerHTML += `<div class="legend-item">
                            <span class="legend-color" style="background: ${campaignColors[campaign]}"></span>
                            ${campaign.replace('MCD-', '')}
                        </div>`;
                    });
                    return div;
                };
                legend.addTo(map);

                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('loading').innerHTML = `Error loading data: ${error.message}`;
            }
        }

        // Initialize the map when page loads
        initializeMap();
    </script>
</body>
</html>